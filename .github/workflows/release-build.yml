name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to create release for'
        required: true
        type: string

jobs:
  release-build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $tag = "${{ github.event.inputs.tag }}"
          } else {
            $tag = "${{ github.ref_name }}"
          }
          
          $version = $tag -replace '^v', ''
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "is-prerelease=$($tag -match '-(alpha|beta|rc)')" >> $env:GITHUB_OUTPUT
          
          Write-Host "Tag: $tag"
          Write-Host "Version: $version"

      - name: Setup .NET Framework
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore ppmeta.sln

      - name: Setup certificate for VSTO signing
        shell: pwsh
        env:
          VSTO_CERTIFICATE: ${{ secrets.VSTO_CERTIFICATE }}
          VSTO_CERT_THUMBPRINT: ${{ secrets.VSTO_CERT_THUMBPRINT }}
          VSTO_CERT_PASSWORD: ${{ secrets.VSTO_CERT_PASSWORD }}
        run: |
          if ($env:VSTO_CERTIFICATE) {
            Write-Host "Using production certificate from secrets..."
            
            $certBytes = [System.Convert]::FromBase64String($env:VSTO_CERTIFICATE)
            [System.IO.File]::WriteAllBytes("ppmeta\production_cert.pfx", $certBytes)
            
            echo "CERT_THUMBPRINT=$env:VSTO_CERT_THUMBPRINT" >> $env:GITHUB_ENV
            echo "CERT_PASSWORD=$env:VSTO_CERT_PASSWORD" >> $env:GITHUB_ENV
            echo "CERT_PATH=production_cert.pfx" >> $env:GITHUB_ENV
            echo "IS_PRODUCTION_CERT=true" >> $env:GITHUB_ENV
          } else {
            Write-Host "Warning: No production certificate provided, using temporary certificate..."
            
            $cert = New-SelfSignedCertificate -Subject "CN=PPMeta Release Build" -Type CodeSigning -KeyUsage DigitalSignature -FriendlyName "PPMeta Release Certificate" -CertStoreLocation Cert:\CurrentUser\My -HashAlgorithm SHA256
            
            $pwd = ConvertTo-SecureString -String "TempPassword123!" -Force -AsPlainText
            Export-PfxCertificate -Cert $cert -FilePath "ppmeta\temp_cert.pfx" -Password $pwd
            
            echo "CERT_THUMBPRINT=$($cert.Thumbprint)" >> $env:GITHUB_ENV
            echo "CERT_PASSWORD=TempPassword123!" >> $env:GITHUB_ENV
            echo "CERT_PATH=temp_cert.pfx" >> $env:GITHUB_ENV
            echo "IS_PRODUCTION_CERT=false" >> $env:GITHUB_ENV
          }

      - name: Install certificate
        shell: pwsh
        run: |
          $certPath = "ppmeta\$env:CERT_PATH"
          $password = ConvertTo-SecureString -String "$env:CERT_PASSWORD" -Force -AsPlainText
          
          $cert = Import-PfxCertificate -FilePath $certPath -CertStoreLocation Cert:\CurrentUser\My -Password $password
          Write-Host "Certificate installed: $($cert.Thumbprint)"
          
          # 导出公钥证书供用户安装
          $publicCertPath = "ppmeta\PPMeta-CodeSigning-Certificate.cer"
          Export-Certificate -Cert $cert -FilePath $publicCertPath -Type CERT
          Write-Host "Public certificate exported: $publicCertPath"
          
          # 创建证书安装说明
          $certType = if ($env:IS_PRODUCTION_CERT -eq "true") { "生产环境" } else { "开发测试" }
          @"
          PPMeta 代码签名证书安装说明
          =====================================
          
          证书类型: $certType 证书
          
          如果您在运行PPMeta时遇到"Windows无法验证此软件的发布者"警告，
          请按照以下步骤安装我们的代码签名证书：
          
          方法1: 双击安装（推荐）
          1. 双击 PPMeta-CodeSigning-Certificate.cer 文件
          2. 点击"安装证书..."
          3. 选择"当前用户"，点击"下一步"
          4. 选择"将所有的证书都放入下列存储"
          5. 点击"浏览..."，选择"受信任的发布者"
          6. 点击"确定"，然后"下一步"，最后"完成"
          
          方法2: 使用PowerShell（管理员权限）
          1. 以管理员身份运行PowerShell
          2. 执行命令：
             Import-Certificate -FilePath "PPMeta-CodeSigning-Certificate.cer" -CertStoreLocation Cert:\LocalMachine\TrustedPublisher
          
          方法3: 使用组策略（企业环境）
          联系您的IT管理员，将此证书添加到"受信任的发布者"组策略中。
          
          注意事项：
          - 安装证书后，PPMeta软件将被Windows信任
          - 此证书仅用于验证PPMeta软件的真实性
          - 如果您不信任此证书，请不要安装
          $(if ($env:IS_PRODUCTION_CERT -eq "false") { "- ⚠️ 这是开发测试证书，不是正式CA颁发的证书" })
          
          证书信息：
          主题: $($cert.Subject)
          指纹: $($cert.Thumbprint)
          有效期: $($cert.NotBefore.ToString('yyyy-MM-dd')) 至 $($cert.NotAfter.ToString('yyyy-MM-dd'))
          "@ | Out-File -FilePath "ppmeta\CERTIFICATE_INSTALL_GUIDE.txt" -Encoding UTF8
          
          $projFile = "ppmeta\ppmeta.csproj"
          $content = Get-Content $projFile -Raw
          $content = $content -replace '<ManifestCertificateThumbprint>.*</ManifestCertificateThumbprint>', "<ManifestCertificateThumbprint>$($cert.Thumbprint)</ManifestCertificateThumbprint>"
          Set-Content $projFile $content
          
          if ($env:IS_PRODUCTION_CERT -eq "false") {
            Write-Host "⚠️ Warning: Using temporary certificate for release build. Consider using a production certificate."
          }

      - name: Build solution (Release)
        run: msbuild ppmeta.sln /p:Configuration=Release /p:Platform="Any CPU"

      - name: Setup Visual Studio devenv
        uses: seanmiddleditch/gha-setup-vsdevenv@v4

      - name: Build installer
        shell: pwsh
        run: |
          if (Test-Path "ppSetup\ppSetup.vdproj") {
            Write-Host "Building Visual Studio installer project with devenv..."
            
            try {
              devenv ppSetup\ppSetup.vdproj /build Release
              Write-Host "Installer built successfully"
            }
            catch {
              Write-Host "Failed to build installer: $($_.Exception.Message)"
            }
          } else {
            Write-Host "No installer project found"
          }

      - name: Create release artifacts
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $tag = "${{ steps.version.outputs.tag }}"
          $artifactDir = "ppmeta-$version"
          
          New-Item -ItemType Directory -Path $artifactDir -Force
          
          Copy-Item "ppmeta\bin\Release\*" $artifactDir -Recurse -Force
          
          if (Test-Path "ppSetup\Release\ppSetup.msi") {
            Copy-Item "ppSetup\Release\ppSetup.msi" "$artifactDir\ppmeta-$version.msi"
          }
          
          # 复制证书文件和安装说明
          if (Test-Path "ppmeta\PPMeta-CodeSigning-Certificate.cer") {
            Copy-Item "ppmeta\PPMeta-CodeSigning-Certificate.cer" $artifactDir
          }
          if (Test-Path "ppmeta\CERTIFICATE_INSTALL_GUIDE.txt") {
            Copy-Item "ppmeta\CERTIFICATE_INSTALL_GUIDE.txt" $artifactDir
          }
          
          if (Test-Path "README.md") {
            Copy-Item "README.md" $artifactDir
          }
          if (Test-Path "LICENSE") {
            Copy-Item "LICENSE" $artifactDir
          }
          
          @"
          PPMeta Release Build
          Version: $version
          Tag: $tag
          Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
          Commit: $(git rev-parse HEAD)
          
          安装说明:
          1. 运行 ppmeta-$version.msi 安装PPMeta
          2. 如果遇到"Windows无法验证此软件的发布者"警告，请先安装证书：
             - 双击 PPMeta-CodeSigning-Certificate.cer
             - 按照 CERTIFICATE_INSTALL_GUIDE.txt 中的说明操作
          
          文件说明:
          - ppmeta-$version.msi: PPMeta安装程序
          - PPMeta-CodeSigning-Certificate.cer: 代码签名证书（用于信任验证）
          - CERTIFICATE_INSTALL_GUIDE.txt: 证书安装详细说明
          
          安全提醒:
          本软件已经过代码签名，请在安装证书后使用以确保安全性。
          证书安装后，Windows将信任PPMeta软件，避免安全警告。
          
          Release Notes:
          Please see the GitHub release page for detailed release notes.
          "@ | Out-File -FilePath "$artifactDir\VERSION.txt" -Encoding UTF8
          
          Compress-Archive -Path "$artifactDir\*" -DestinationPath "ppmeta-$version.zip"

      - name: Generate release notes
        id: release-notes
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          
          $previousTag = git describe --tags --abbrev=0 HEAD^ 2>$null
          if ($previousTag) {
            Write-Host "Previous tag: $previousTag"
            $commitRange = "$previousTag..HEAD"
          } else {
            Write-Host "No previous tag found, using all commits"
            $commitRange = "HEAD"
          }
          
          $commits = git log $commitRange --pretty=format:"- %s (%h)" --no-merges
          
          $releaseNotes = @"
          ## What's Changed
          
          $commits
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/$previousTag...${{ steps.version.outputs.tag }}
          "@
          
          $releaseNotes | Out-File -FilePath "release-notes.txt" -Encoding UTF8
          echo "notes-file=release-notes.txt" >> $env:GITHUB_OUTPUT

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ppmeta-${{ steps.version.outputs.version }}
          path: |
            ppmeta-${{ steps.version.outputs.version }}.zip
            ppmeta-${{ steps.version.outputs.version }}/
          retention-days: 90

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "PPMeta ${{ steps.version.outputs.version }}"
          body_path: ${{ steps.release-notes.outputs.notes-file }}
          files: |
            ppmeta-${{ steps.version.outputs.version }}.zip
            ppmeta-${{ steps.version.outputs.version }}/ppmeta-${{ steps.version.outputs.version }}.msi
          prerelease: ${{ steps.version.outputs.is-prerelease == 'true' }}
          make_latest: ${{ steps.version.outputs.is-prerelease == 'false' }}
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Notify release
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $isPrerelease = "${{ steps.version.outputs.is-prerelease }}"
          
          if ($isPrerelease -eq "true") {
            Write-Host "🚀 Pre-release $version has been created!"
          } else {
            Write-Host "🎉 Release $version has been created!"
          }
          
          Write-Host "Release URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
