name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to create release for'
        required: true
        type: string

permissions:
  contents: write  # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»ºrelease
  actions: read    # éœ€è¦è¯»å–actionsæƒé™

jobs:
  release-build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $tag = "${{ github.event.inputs.tag }}"
          } else {
            $tag = "${{ github.ref_name }}"
          }
          
          $version = $tag -replace '^v', ''
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "is-prerelease=$($tag -match '-(alpha|beta|rc)')" >> $env:GITHUB_OUTPUT
          
          Write-Host "Tag: $tag"
          Write-Host "Version: $version"

      - name: Setup .NET Framework
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore ppmeta.sln

      - name: Setup certificate for VSTO signing
        shell: pwsh
        env:
          VSTO_CERTIFICATE: ${{ secrets.VSTO_CERTIFICATE }}
          VSTO_CERT_THUMBPRINT: ${{ secrets.VSTO_CERT_THUMBPRINT }}
          VSTO_CERT_PASSWORD: ${{ secrets.VSTO_CERT_PASSWORD }}
        run: |
          if ($env:VSTO_CERTIFICATE) {
            Write-Host "Using production certificate from secrets..."
            
            $certBytes = [System.Convert]::FromBase64String($env:VSTO_CERTIFICATE)
            [System.IO.File]::WriteAllBytes("ppmeta\production_cert.pfx", $certBytes)
            
            echo "CERT_THUMBPRINT=$env:VSTO_CERT_THUMBPRINT" >> $env:GITHUB_ENV
            echo "CERT_PASSWORD=$env:VSTO_CERT_PASSWORD" >> $env:GITHUB_ENV
            echo "CERT_PATH=production_cert.pfx" >> $env:GITHUB_ENV
            echo "IS_PRODUCTION_CERT=true" >> $env:GITHUB_ENV
          } else {
            Write-Host "Warning: No production certificate provided, using temporary certificate..."
            
            $cert = New-SelfSignedCertificate -Subject "CN=PPMeta Release Build" -Type CodeSigning -KeyUsage DigitalSignature -FriendlyName "PPMeta Release Certificate" -CertStoreLocation Cert:\CurrentUser\My -HashAlgorithm SHA256
            
            $pwd = ConvertTo-SecureString -String "TempPassword123!" -Force -AsPlainText
            Export-PfxCertificate -Cert $cert -FilePath "ppmeta\temp_cert.pfx" -Password $pwd
            
            echo "CERT_THUMBPRINT=$($cert.Thumbprint)" >> $env:GITHUB_ENV
            echo "CERT_PASSWORD=TempPassword123!" >> $env:GITHUB_ENV
            echo "CERT_PATH=temp_cert.pfx" >> $env:GITHUB_ENV
            echo "IS_PRODUCTION_CERT=false" >> $env:GITHUB_ENV
          }

      - name: Install certificate
        shell: pwsh
        run: |
          $certPath = "ppmeta\$env:CERT_PATH"
          $password = ConvertTo-SecureString -String "$env:CERT_PASSWORD" -Force -AsPlainText
          
          $cert = Import-PfxCertificate -FilePath $certPath -CertStoreLocation Cert:\CurrentUser\My -Password $password
          Write-Host "Certificate installed: $($cert.Thumbprint)"
          
          # å¯¼å‡ºå…¬é’¥è¯ä¹¦ä¾›ç”¨æˆ·å®‰è£…
          $publicCertPath = "ppmeta\PPMeta-CodeSigning-Certificate.cer"
          Export-Certificate -Cert $cert -FilePath $publicCertPath -Type CERT
          Write-Host "Public certificate exported: $publicCertPath"
          
          # åˆ›å»ºè¯ä¹¦å®‰è£…è¯´æ˜
          $certType = if ($env:IS_PRODUCTION_CERT -eq "true") { "ç”Ÿäº§ç¯å¢ƒ" } else { "å¼€å‘æµ‹è¯•" }
          @"
          PPMeta ä»£ç ç­¾åè¯ä¹¦å®‰è£…è¯´æ˜
          =====================================
          
          è¯ä¹¦ç±»å‹: $certType è¯ä¹¦
          
          å¦‚æœæ‚¨åœ¨è¿è¡ŒPPMetaæ—¶é‡åˆ°"Windowsæ— æ³•éªŒè¯æ­¤è½¯ä»¶çš„å‘å¸ƒè€…"è­¦å‘Šï¼Œ
          è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å®‰è£…æˆ‘ä»¬çš„ä»£ç ç­¾åè¯ä¹¦ï¼š
          
          æ–¹æ³•1: åŒå‡»å®‰è£…ï¼ˆæ¨èï¼‰
          1. åŒå‡» PPMeta-CodeSigning-Certificate.cer æ–‡ä»¶
          2. ç‚¹å‡»"å®‰è£…è¯ä¹¦..."
          3. é€‰æ‹©"å½“å‰ç”¨æˆ·"ï¼Œç‚¹å‡»"ä¸‹ä¸€æ­¥"
          4. é€‰æ‹©"å°†æ‰€æœ‰çš„è¯ä¹¦éƒ½æ”¾å…¥ä¸‹åˆ—å­˜å‚¨"
          5. ç‚¹å‡»"æµè§ˆ..."ï¼Œé€‰æ‹©"å—ä¿¡ä»»çš„å‘å¸ƒè€…"
          6. ç‚¹å‡»"ç¡®å®š"ï¼Œç„¶å"ä¸‹ä¸€æ­¥"ï¼Œæœ€å"å®Œæˆ"
          
          æ–¹æ³•2: ä½¿ç”¨PowerShellï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
          1. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡ŒPowerShell
          2. æ‰§è¡Œå‘½ä»¤ï¼š
             Import-Certificate -FilePath "PPMeta-CodeSigning-Certificate.cer" -CertStoreLocation Cert:\LocalMachine\TrustedPublisher
          
          æ–¹æ³•3: ä½¿ç”¨ç»„ç­–ç•¥ï¼ˆä¼ä¸šç¯å¢ƒï¼‰
          è”ç³»æ‚¨çš„ITç®¡ç†å‘˜ï¼Œå°†æ­¤è¯ä¹¦æ·»åŠ åˆ°"å—ä¿¡ä»»çš„å‘å¸ƒè€…"ç»„ç­–ç•¥ä¸­ã€‚
          
          æ³¨æ„äº‹é¡¹ï¼š
          - å®‰è£…è¯ä¹¦åï¼ŒPPMetaè½¯ä»¶å°†è¢«Windowsä¿¡ä»»
          - æ­¤è¯ä¹¦ä»…ç”¨äºéªŒè¯PPMetaè½¯ä»¶çš„çœŸå®æ€§
          - å¦‚æœæ‚¨ä¸ä¿¡ä»»æ­¤è¯ä¹¦ï¼Œè¯·ä¸è¦å®‰è£…
          $(if ($env:IS_PRODUCTION_CERT -eq "false") { "- âš ï¸ è¿™æ˜¯å¼€å‘æµ‹è¯•è¯ä¹¦ï¼Œä¸æ˜¯æ­£å¼CAé¢å‘çš„è¯ä¹¦" })
          
          è¯ä¹¦ä¿¡æ¯ï¼š
          ä¸»é¢˜: $($cert.Subject)
          æŒ‡çº¹: $($cert.Thumbprint)
          æœ‰æ•ˆæœŸ: $($cert.NotBefore.ToString('yyyy-MM-dd')) è‡³ $($cert.NotAfter.ToString('yyyy-MM-dd'))
          "@ | Out-File -FilePath "ppmeta\CERTIFICATE_INSTALL_GUIDE.txt" -Encoding UTF8
          
          $projFile = "ppmeta\ppmeta.csproj"
          $content = Get-Content $projFile -Raw
          $content = $content -replace '<ManifestCertificateThumbprint>.*</ManifestCertificateThumbprint>', "<ManifestCertificateThumbprint>$($cert.Thumbprint)</ManifestCertificateThumbprint>"
          Set-Content $projFile $content
          
          if ($env:IS_PRODUCTION_CERT -eq "false") {
            Write-Host "âš ï¸ Warning: Using temporary certificate for release build. Consider using a production certificate."
          }

      - name: Setup Visual Studio devenv
        uses: seanmiddleditch/gha-setup-vsdevenv@v4

      - name: Build installer with dependencies
        shell: pwsh
        run: |
          if (Test-Path "ppSetup\ppSetup.vdproj") {
            Write-Host "Building Visual Studio installer project with devenv..."
            Write-Host "Note: devenv will automatically build ppmeta project dependencies if needed"
            
            try {
              # ä½¿ç”¨/buildå‘½ä»¤ï¼Œè¿™ä¼šè‡ªåŠ¨å¤„ç†é¡¹ç›®ä¾èµ–å…³ç³»
              devenv ppmeta.sln /build Release /project ppSetup
              Write-Host "Installer built successfully with dependencies"
              
              # éªŒè¯è¾“å‡ºæ–‡ä»¶
              if (Test-Path "ppSetup\Release\ppSetup.msi") {
                Write-Host "âœ… MSI installer created: ppSetup\Release\ppSetup.msi"
                $msiSize = (Get-Item "ppSetup\Release\ppSetup.msi").Length
                Write-Host "   File size: $([math]::Round($msiSize/1MB, 2)) MB"
              } else {
                Write-Host "âŒ MSI installer not found at expected location"
                Write-Host "Checking alternative locations..."
                Get-ChildItem -Recurse -Filter "*.msi" | ForEach-Object { Write-Host "Found MSI: $($_.FullName)" }
              }
            }
            catch {
              Write-Host "Failed to build installer: $($_.Exception.Message)"
              Write-Host "Checking for partial build outputs..."
              if (Test-Path "ppSetup\Release") {
                Get-ChildItem "ppSetup\Release" | ForEach-Object { Write-Host "   $($_.Name)" }
              }
              throw
            }
          } else {
            Write-Host "No installer project found at ppSetup\ppSetup.vdproj"
          }

      - name: Create release artifacts
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $tag = "${{ steps.version.outputs.tag }}"
          $buildDate = Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC'
          $commit = git rev-parse HEAD
          
          # åˆ›å»ºä¸¤ä¸ªç‹¬ç«‹çš„äº§ç‰©ç›®å½•
          $msiPackageDir = "PPMeta-MSI-Installer-$version"
          $vstoPackageDir = "PPMeta-VSTO-Package-$version"
          
          New-Item -ItemType Directory -Path $msiPackageDir -Force
          New-Item -ItemType Directory -Path $vstoPackageDir -Force
          
          # å¤åˆ¶å…±åŒçš„è¯ä¹¦æ–‡ä»¶å’Œå®‰è£…è¯´æ˜
          if (Test-Path "ppmeta\PPMeta-CodeSigning-Certificate.cer") {
            Copy-Item "ppmeta\PPMeta-CodeSigning-Certificate.cer" $msiPackageDir
            Copy-Item "ppmeta\PPMeta-CodeSigning-Certificate.cer" $vstoPackageDir
          }
          if (Test-Path "ppmeta\CERTIFICATE_INSTALL_GUIDE.txt") {
            Copy-Item "ppmeta\CERTIFICATE_INSTALL_GUIDE.txt" $msiPackageDir
            Copy-Item "ppmeta\CERTIFICATE_INSTALL_GUIDE.txt" $vstoPackageDir
          }
          
          # ==================== MSI å®‰è£…ç¨‹åºåŒ… ====================
          if (Test-Path "ppSetup\Release\ppSetup.msi") {
            Copy-Item "ppSetup\Release\ppSetup.msi" "$msiPackageDir\PPMeta-$version.msi"
            
            @"
          PPMeta MSI å®‰è£…ç¨‹åºåŒ…
          ========================================
          
          ç‰ˆæœ¬ä¿¡æ¯:
          - ç‰ˆæœ¬: $version
          - æ ‡ç­¾: $tag  
          - æ„å»ºæ—¶é—´: $buildDate
          - Gitæäº¤: $commit
          
          åŒ…å«æ–‡ä»¶:
          - PPMeta-$version.msi: MSIå®‰è£…ç¨‹åºï¼ˆWindows Installeræ ¼å¼ï¼‰
          - PPMeta-CodeSigning-Certificate.cer: ä»£ç ç­¾åè¯ä¹¦
          - CERTIFICATE_INSTALL_GUIDE.txt: è¯ä¹¦å®‰è£…è¯¦ç»†æŒ‡å—
          
          å®‰è£…è¯´æ˜:
          1. ã€æ¨èã€‘å…ˆå®‰è£…è¯ä¹¦ä»¥é¿å…å®‰å…¨è­¦å‘Šï¼š
             - åŒå‡» PPMeta-CodeSigning-Certificate.cer
             - æŒ‰ç…§ CERTIFICATE_INSTALL_GUIDE.txt ä¸­çš„è¯¦ç»†è¯´æ˜æ“ä½œ
          2. åŒå‡» PPMeta-$version.msi å¼€å§‹å®‰è£…
          3. æŒ‰ç…§å®‰è£…å‘å¯¼å®ŒæˆPowerPointæ’ä»¶å®‰è£…
          
          é€‚ç”¨åœºæ™¯:
          - ä¸ªäººç”¨æˆ·å¿«é€Ÿå®‰è£…
          - ä¼ä¸šç¯å¢ƒé›†ä¸­éƒ¨ç½²
          - æ”¯æŒé™é»˜å®‰è£…å‚æ•°
          
          ç³»ç»Ÿè¦æ±‚:
          - Windows 10/11
          - Microsoft PowerPoint 2016æˆ–æ›´é«˜ç‰ˆæœ¬
          - .NET Framework 4.8
          
          å®‰å…¨æé†’:
          æœ¬è½¯ä»¶å·²ç»è¿‡ä»£ç ç­¾åï¼Œå®‰è£…è¯ä¹¦åWindowså°†ä¿¡ä»»PPMetaè½¯ä»¶ã€‚
          å¦‚æœä¸å®‰è£…è¯ä¹¦ï¼Œå¯èƒ½ä¼šæ”¶åˆ°"Windowsæ— æ³•éªŒè¯æ­¤è½¯ä»¶çš„å‘å¸ƒè€…"è­¦å‘Šã€‚
          "@ | Out-File -FilePath "$msiPackageDir\README.txt" -Encoding UTF8
          } else {
            Write-Host "âš ï¸ Warning: MSI installer not found at ppSetup\Release\ppSetup.msi"
          }
          
          # ==================== VSTO å®‰è£…ç¨‹åºåŒ… ====================
          if (Test-Path "ppmeta\bin\Release") {
            # å¤åˆ¶VSTOæ–‡ä»¶
            Copy-Item "ppmeta\bin\Release\*" $vstoPackageDir -Recurse -Force
            
            # å¤åˆ¶é¡¹ç›®æ–‡æ¡£
            if (Test-Path "README.md") {
              Copy-Item "README.md" $vstoPackageDir
            }
            if (Test-Path "LICENSE") {
              Copy-Item "LICENSE" $vstoPackageDir
            }
            
            @"
          PPMeta VSTO å¼€å‘åŒ…
          ========================================
          
          ç‰ˆæœ¬ä¿¡æ¯:
          - ç‰ˆæœ¬: $version
          - æ ‡ç­¾: $tag
          - æ„å»ºæ—¶é—´: $buildDate
          - Gitæäº¤: $commit
          
          åŒ…å«æ–‡ä»¶:
          - PPMeta.dll: ä¸»è¦çš„VSTOç¨‹åºé›†
          - PPMeta.vsto: VSTOéƒ¨ç½²æ¸…å•æ–‡ä»¶
          - PPMeta.dll.manifest: åº”ç”¨ç¨‹åºæ¸…å•
          - PPMeta-CodeSigning-Certificate.cer: ä»£ç ç­¾åè¯ä¹¦
          - CERTIFICATE_INSTALL_GUIDE.txt: è¯ä¹¦å®‰è£…è¯¦ç»†æŒ‡å—
          - å…¶ä»–ä¾èµ–æ–‡ä»¶å’Œèµ„æº
          
          å®‰è£…è¯´æ˜:
          1. ã€å¿…é¡»ã€‘å…ˆå®‰è£…è¯ä¹¦ï¼š
             - åŒå‡» PPMeta-CodeSigning-Certificate.cer
             - æŒ‰ç…§ CERTIFICATE_INSTALL_GUIDE.txt ä¸­çš„è¯¦ç»†è¯´æ˜æ“ä½œ
          2. åŒå‡» PPMeta.vsto æ–‡ä»¶è¿›è¡Œå®‰è£…
          3. å¦‚æœæç¤ºå®‰å…¨è­¦å‘Šï¼Œç‚¹å‡»"å®‰è£…"
          
          é€‚ç”¨åœºæ™¯:
          - å¼€å‘äººå‘˜æµ‹è¯•éƒ¨ç½²
          - è‡ªå®šä¹‰å®‰è£…éœ€æ±‚
          - ç½‘ç»œå…±äº«éƒ¨ç½²
          - ClickOnceéƒ¨ç½²æ–¹å¼
          
          ç³»ç»Ÿè¦æ±‚:
          - Windows 10/11
          - Microsoft PowerPoint 2016æˆ–æ›´é«˜ç‰ˆæœ¬
          - .NET Framework 4.8
          - Visual Studio Tools for Office Runtime
          
          æŠ€æœ¯è¯´æ˜:
          VSTO (Visual Studio Tools for Office) æ˜¯å¾®è½¯æä¾›çš„Officeæ’ä»¶å¼€å‘æ¡†æ¶ã€‚
          æ­¤åŒ…åŒ…å«å®Œæ•´çš„VSTOéƒ¨ç½²æ–‡ä»¶ï¼Œå¯ç”¨äºç›´æ¥å®‰è£…æˆ–è¿›ä¸€æ­¥å®šåˆ¶éƒ¨ç½²ã€‚
          
          å®‰å…¨æé†’:
          VSTOæ’ä»¶å¿…é¡»ä½¿ç”¨å—ä¿¡ä»»çš„è¯ä¹¦ç­¾åæ‰èƒ½å®‰è£…ã€‚è¯·åŠ¡å¿…å…ˆå®‰è£…æä¾›çš„è¯ä¹¦ã€‚
          "@ | Out-File -FilePath "$vstoPackageDir\README.txt" -Encoding UTF8
          } else {
            Write-Host "âš ï¸ Warning: VSTO build output not found at ppmeta\bin\Release"
          }
          
          # åˆ›å»ºZIPæ–‡ä»¶
          if (Test-Path $msiPackageDir) {
            Compress-Archive -Path "$msiPackageDir\*" -DestinationPath "$msiPackageDir.zip"
            Write-Host "âœ… Created MSI package: $msiPackageDir.zip"
          }
          
          if (Test-Path $vstoPackageDir) {
            Compress-Archive -Path "$vstoPackageDir\*" -DestinationPath "$vstoPackageDir.zip"
            Write-Host "âœ… Created VSTO package: $vstoPackageDir.zip"
          }

      - name: Generate release notes
        id: release-notes
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          
          $previousTag = git describe --tags --abbrev=0 HEAD^ 2>$null
          if ($previousTag) {
            Write-Host "Previous tag: $previousTag"
            $commitRange = "$previousTag..HEAD"
          } else {
            Write-Host "No previous tag found, using all commits"
            $commitRange = "HEAD"
          }
          
          $commits = git log $commitRange --pretty=format:"- %s (%h)" --no-merges
          
          $releaseNotes = @"
          ## What's Changed
          
          $commits
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/$previousTag...${{ steps.version.outputs.tag }}
          "@
          
          $releaseNotes | Out-File -FilePath "release-notes.txt" -Encoding UTF8
          echo "notes-file=release-notes.txt" >> $env:GITHUB_OUTPUT

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ppmeta-release-${{ steps.version.outputs.version }}
          path: |
            PPMeta-MSI-Installer-${{ steps.version.outputs.version }}.zip
            PPMeta-VSTO-Package-${{ steps.version.outputs.version }}.zip
          retention-days: 90

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "PPMeta ${{ steps.version.outputs.version }}"
          body_path: ${{ steps.release-notes.outputs.notes-file }}
          files: |
            PPMeta-MSI-Installer-${{ steps.version.outputs.version }}.zip
            PPMeta-VSTO-Package-${{ steps.version.outputs.version }}.zip
          prerelease: ${{ steps.version.outputs.is-prerelease == 'true' }}
          make_latest: ${{ steps.version.outputs.is-prerelease == 'false' }}
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Notify release
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $isPrerelease = "${{ steps.version.outputs.is-prerelease }}"
          
          if ($isPrerelease -eq "true") {
            Write-Host "ğŸš€ Pre-release $version has been created!"
          } else {
            Write-Host "ğŸ‰ Release $version has been created!"
          }
          
          Write-Host "Release URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
