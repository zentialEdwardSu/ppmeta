name: Nightly Build

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  check-commits:
    runs-on: windows-latest
    outputs:
      should-build: ${{ steps.check.outputs.should-build }}
      commit-count: ${{ steps.check.outputs.commit-count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for commits in last 24 hours
        id: check
        shell: pwsh
        run: |
          $yesterday = (Get-Date).AddDays(-1).ToString("yyyy-MM-dd")
          $commitCount = git rev-list --count --since="$yesterday" HEAD
          Write-Host "Commits in last 24 hours: $commitCount"
          
          if ($commitCount -gt 0) {
            echo "should-build=true" >> $env:GITHUB_OUTPUT
            echo "commit-count=$commitCount" >> $env:GITHUB_OUTPUT
            Write-Host "New commits found, will proceed with nightly build"
          } else {
            echo "should-build=false" >> $env:GITHUB_OUTPUT
            echo "commit-count=0" >> $env:GITHUB_OUTPUT
            Write-Host "No new commits, skipping nightly build"
          }

  nightly-build:
    runs-on: windows-latest
    needs: check-commits
    if: needs.check-commits.outputs.should-build == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET Framework
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore ppmeta.sln

      - name: Setup certificate for VSTO signing
        shell: pwsh
        env:
          VSTO_CERTIFICATE: ${{ secrets.VSTO_CERTIFICATE }}
          VSTO_CERT_THUMBPRINT: ${{ secrets.VSTO_CERT_THUMBPRINT }}
          VSTO_CERT_PASSWORD: ${{ secrets.VSTO_CERT_PASSWORD }}
        run: |
          if (-not $env:VSTO_CERTIFICATE) {
            Write-Host "No certificate provided, creating temporary certificate..."
            
            $cert = New-SelfSignedCertificate -Subject "CN=PPMeta CI Build" -Type CodeSigning -KeyUsage DigitalSignature -FriendlyName "PPMeta CI Certificate" -CertStoreLocation Cert:\CurrentUser\My -HashAlgorithm SHA256
            
            $pwd = ConvertTo-SecureString -String "TempPassword123!" -Force -AsPlainText
            Export-PfxCertificate -Cert $cert -FilePath "ppmeta\temp_cert.pfx" -Password $pwd
            
            Write-Host "Temporary certificate created: $($cert.Thumbprint)"
            echo "CERT_THUMBPRINT=$($cert.Thumbprint)" >> $env:GITHUB_ENV
            echo "CERT_PASSWORD=TempPassword123!" >> $env:GITHUB_ENV
            echo "CERT_PATH=temp_cert.pfx" >> $env:GITHUB_ENV
          } else {
            Write-Host "Using provided certificate from secrets..."
            
            $certBytes = [System.Convert]::FromBase64String($env:VSTO_CERTIFICATE)
            [System.IO.File]::WriteAllBytes("ppmeta\production_cert.pfx", $certBytes)
            
            echo "CERT_THUMBPRINT=$env:VSTO_CERT_THUMBPRINT" >> $env:GITHUB_ENV
            echo "CERT_PASSWORD=$env:VSTO_CERT_PASSWORD" >> $env:GITHUB_ENV
            echo "CERT_PATH=production_cert.pfx" >> $env:GITHUB_ENV
          }

      - name: Install certificate
        shell: pwsh
        run: |
          $certPath = "ppmeta\$env:CERT_PATH"
          $password = ConvertTo-SecureString -String "$env:CERT_PASSWORD" -Force -AsPlainText
          
          $cert = Import-PfxCertificate -FilePath $certPath -CertStoreLocation Cert:\CurrentUser\My -Password $password
          Write-Host "Certificate installed: $($cert.Thumbprint)"
          
          # å¯¼å‡ºå…¬é’¥è¯ä¹¦ä¾›ç”¨æˆ·å®‰è£…
          $publicCertPath = "ppmeta\PPMeta-CodeSigning-Certificate.cer"
          Export-Certificate -Cert $cert -FilePath $publicCertPath -Type CERT
          Write-Host "Public certificate exported: $publicCertPath"
          
          # åˆ›å»ºè¯ä¹¦å®‰è£…è¯´æ˜
          @"
          PPMeta ä»£ç ç­¾åè¯ä¹¦å®‰è£…è¯´æ˜
          =====================================
          
          å¦‚æœæ‚¨åœ¨è¿è¡ŒPPMetaæ—¶é‡åˆ°"Windowsæ— æ³•éªŒè¯æ­¤è½¯ä»¶çš„å‘å¸ƒè€…"è­¦å‘Šï¼Œ
          è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å®‰è£…æˆ‘ä»¬çš„ä»£ç ç­¾åè¯ä¹¦ï¼š
          
          æ–¹æ³•1: åŒå‡»å®‰è£…ï¼ˆæ¨èï¼‰
          1. åŒå‡» PPMeta-CodeSigning-Certificate.cer æ–‡ä»¶
          2. ç‚¹å‡»"å®‰è£…è¯ä¹¦..."
          3. é€‰æ‹©"å½“å‰ç”¨æˆ·"ï¼Œç‚¹å‡»"ä¸‹ä¸€æ­¥"
          4. é€‰æ‹©"å°†æ‰€æœ‰çš„è¯ä¹¦éƒ½æ”¾å…¥ä¸‹åˆ—å­˜å‚¨"
          5. ç‚¹å‡»"æµè§ˆ..."ï¼Œé€‰æ‹©"å—ä¿¡ä»»çš„å‘å¸ƒè€…"
          6. ç‚¹å‡»"ç¡®å®š"ï¼Œç„¶å"ä¸‹ä¸€æ­¥"ï¼Œæœ€å"å®Œæˆ"
          
          æ–¹æ³•2: ä½¿ç”¨PowerShellï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
          1. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡ŒPowerShell
          2. æ‰§è¡Œå‘½ä»¤ï¼š
             Import-Certificate -FilePath "PPMeta-CodeSigning-Certificate.cer" -CertStoreLocation Cert:\LocalMachine\TrustedPublisher
          
          æ–¹æ³•3: ä½¿ç”¨ç»„ç­–ç•¥ï¼ˆä¼ä¸šç¯å¢ƒï¼‰
          è”ç³»æ‚¨çš„ITç®¡ç†å‘˜ï¼Œå°†æ­¤è¯ä¹¦æ·»åŠ åˆ°"å—ä¿¡ä»»çš„å‘å¸ƒè€…"ç»„ç­–ç•¥ä¸­ã€‚
          
          æ³¨æ„äº‹é¡¹ï¼š
          - å®‰è£…è¯ä¹¦åï¼ŒPPMetaè½¯ä»¶å°†è¢«Windowsä¿¡ä»»
          - æ­¤è¯ä¹¦ä»…ç”¨äºéªŒè¯PPMetaè½¯ä»¶çš„çœŸå®æ€§
          - å¦‚æœæ‚¨ä¸ä¿¡ä»»æ­¤è¯ä¹¦ï¼Œè¯·ä¸è¦å®‰è£…
          
          è¯ä¹¦ä¿¡æ¯ï¼š
          ä¸»é¢˜: $($cert.Subject)
          æŒ‡çº¹: $($cert.Thumbprint)
          æœ‰æ•ˆæœŸ: $($cert.NotBefore.ToString('yyyy-MM-dd')) è‡³ $($cert.NotAfter.ToString('yyyy-MM-dd'))
          "@ | Out-File -FilePath "ppmeta\CERTIFICATE_INSTALL_GUIDE.txt" -Encoding UTF8
          
          $projFile = "ppmeta\ppmeta.csproj"
          $content = Get-Content $projFile -Raw
          $content = $content -replace '<ManifestCertificateThumbprint>.*</ManifestCertificateThumbprint>', "<ManifestCertificateThumbprint>$($cert.Thumbprint)</ManifestCertificateThumbprint>"
          Set-Content $projFile $content

      - name: Build solution (Release)
        run: msbuild ppmeta.sln /p:Configuration=Release /p:Platform="Any CPU"

      - name: Setup Visual Studio devenv
        uses: seanmiddleditch/gha-setup-vsdevenv@v4

      - name: Build installer
        shell: pwsh
        run: |
          if (Test-Path "ppSetup\ppSetup.vdproj") {
            Write-Host "Building Visual Studio installer project with devenv..."
            
            try {
              devenv ppSetup\ppSetup.vdproj /build Release
              Write-Host "Installer built successfully"
            }
            catch {
              Write-Host "Failed to build installer: $($_.Exception.Message)"
            }
          } else {
            Write-Host "No installer project found"
          }

      - name: Get commit info
        id: commit-info
        shell: pwsh
        run: |
          $shortSha = git rev-parse --short HEAD
          $commitDate = git log -1 --format=%cd --date=format:%Y%m%d
          $buildVersion = "$commitDate-$shortSha"
          echo "build-version=$buildVersion" >> $env:GITHUB_OUTPUT
          echo "short-sha=$shortSha" >> $env:GITHUB_OUTPUT

      - name: Create nightly release artifacts
        shell: pwsh
        run: |
          $buildVersion = "${{ steps.commit-info.outputs.build-version }}"
          $artifactDir = "nightly-$buildVersion"
          
          New-Item -ItemType Directory -Path $artifactDir -Force
          
          # å¤åˆ¶ä¸»è¦æ„å»ºæ–‡ä»¶
          Copy-Item "ppmeta\bin\Release\*" $artifactDir -Recurse -Force
          
          # å¤åˆ¶å®‰è£…ç¨‹åº (å¦‚æœå­˜åœ¨)
          if (Test-Path "ppSetup\Release\ppSetup.msi") {
            Copy-Item "ppSetup\Release\ppSetup.msi" "$artifactDir\ppmeta-nightly-$buildVersion.msi"
          }
          
          # å¤åˆ¶ä»£ç ç­¾åè¯ä¹¦å’Œå®‰è£…è¯´æ˜
          if (Test-Path "ppmeta\PPMeta-CodeSigning-Certificate.cer") {
            Copy-Item "ppmeta\PPMeta-CodeSigning-Certificate.cer" $artifactDir
            Copy-Item "ppmeta\CERTIFICATE_INSTALL_GUIDE.txt" $artifactDir
            Write-Host "âœ… å·²åŒ…å«ä»£ç ç­¾åè¯ä¹¦å’Œå®‰è£…è¯´æ˜"
          }
          
          # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
          @"
          PPMeta Nightly Build
          Build Version: $buildVersion
          Commit: ${{ steps.commit-info.outputs.short-sha }}
          Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
          Commits in last 24h: ${{ needs.check-commits.outputs.commit-count }}
          
          ğŸ“¦ åŒ…å«æ–‡ä»¶è¯´æ˜ï¼š
          - ppmeta.dll / ppmeta.vsto          - ä¸»ç¨‹åºæ–‡ä»¶
          - PPMeta-CodeSigning-Certificate.cer - ä»£ç ç­¾åè¯ä¹¦ï¼ˆä¾›æ‰‹åŠ¨å®‰è£…ï¼‰
          - CERTIFICATE_INSTALL_GUIDE.txt      - è¯ä¹¦å®‰è£…è¯´æ˜
          - ppmeta-nightly-*.msi              - å®‰è£…ç¨‹åºï¼ˆå¦‚æœå¯ç”¨ï¼‰
          
          ğŸ”’ å®‰å…¨æç¤ºï¼š
          å¦‚æœé‡åˆ°Windowså®‰å…¨è­¦å‘Šï¼Œè¯·å®‰è£…åŒ…å«çš„è¯ä¹¦æ–‡ä»¶ï¼Œè¯¦è§CERTIFICATE_INSTALL_GUIDE.txt
          "@ | Out-File -FilePath "$artifactDir\BUILD_INFO.txt" -Encoding UTF8

      - name: Upload nightly build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ppmeta-nightly-${{ steps.commit-info.outputs.build-version }}
          path: nightly-${{ steps.commit-info.outputs.build-version }}
          retention-days: 30

      - name: Get latest commit message
        id: latest-commit
        shell: pwsh
        run: |
          $commitMessage = git log -1 --oneline
          echo "message=$commitMessage" >> $env:GITHUB_OUTPUT

      - name: Create nightly release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly-${{ steps.commit-info.outputs.build-version }}
          name: "Nightly Build ${{ steps.commit-info.outputs.build-version }}"
          body: |
            ğŸŒ™ **Nightly Build**
            
            This is an automated nightly build containing the latest changes.
            
            **Build Information:**
            - Build Version: `${{ steps.commit-info.outputs.build-version }}`
            - Commit: `${{ steps.commit-info.outputs.short-sha }}`
            - Commits in last 24h: `${{ needs.check-commits.outputs.commit-count }}`
            
            **âš ï¸ Warning:** This is a development build and may be unstable.
            
            **Latest commit:**
            ```
            ${{ steps.latest-commit.outputs.message }}
            ```
          files: |
            nightly-${{ steps.commit-info.outputs.build-version }}/**/*
          prerelease: true
          make_latest: false
          token: ${{ secrets.GITHUB_TOKEN }}
