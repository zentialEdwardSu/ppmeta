name: Build Installer


on:
  workflow_call:
    inputs:
      configuration:
        required: true
        type: string
        default: 'Release'
    outputs:
      installer-path:
        description: "Path to the built installer"
        value: ${{ jobs.build-installer.outputs.installer-path }}
        
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration'
        required: true
        default: 'Release'
        type: choice
        options:
        - Release
        - Debug

jobs:
  build-installer:
    runs-on: windows-latest
    outputs:
      installer-path: ${{ steps.build.outputs.installer-path }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup Visual Studio devenv
        uses: seanmiddleditch/gha-setup-vsdevenv@v4

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore ppmeta.sln

      - name: Setup certificate for VSTO signing
        shell: pwsh
        env:
          VSTO_CERTIFICATE: ${{ secrets.VSTO_CERTIFICATE }}
          VSTO_CERT_THUMBPRINT: ${{ secrets.VSTO_CERT_THUMBPRINT }}
          VSTO_CERT_PASSWORD: ${{ secrets.VSTO_CERT_PASSWORD }}
        run: |
          # è®¾ç½®è¯ä¹¦ç”¨äºVSTOç­¾å
          if (-not $env:VSTO_CERTIFICATE) {
            Write-Host "No certificate provided, creating temporary certificate..."
            
            # åˆ›å»ºè‡ªç­¾åè¯ä¹¦
            $cert = New-SelfSignedCertificate -Subject "CN=PPMeta Build" -Type CodeSigning -KeyUsage DigitalSignature -FriendlyName "PPMeta Build Certificate" -CertStoreLocation Cert:\CurrentUser\My -HashAlgorithm SHA256
            
            # å¯¼å‡ºè¯ä¹¦åˆ°PFXæ–‡ä»¶
            $pwd = ConvertTo-SecureString -String "TempPassword123!" -Force -AsPlainText
            Export-PfxCertificate -Cert $cert -FilePath "ppmeta\temp_cert.pfx" -Password $pwd
            
            echo "CERT_THUMBPRINT=$($cert.Thumbprint)" >> $env:GITHUB_ENV
            echo "CERT_PASSWORD=TempPassword123!" >> $env:GITHUB_ENV
            echo "CERT_PATH=temp_cert.pfx" >> $env:GITHUB_ENV
          } else {
            Write-Host "Using provided certificate from secrets..."
            
            # ä»secretsè§£ç è¯ä¹¦
            $certBytes = [System.Convert]::FromBase64String($env:VSTO_CERTIFICATE)
            [System.IO.File]::WriteAllBytes("ppmeta\production_cert.pfx", $certBytes)
            
            echo "CERT_THUMBPRINT=$env:VSTO_CERT_THUMBPRINT" >> $env:GITHUB_ENV
            echo "CERT_PASSWORD=$env:VSTO_CERT_PASSWORD" >> $env:GITHUB_ENV
            echo "CERT_PATH=production_cert.pfx" >> $env:GITHUB_ENV
          }

      - name: Install certificate
        shell: pwsh
        run: |
          $certPath = "ppmeta\$env:CERT_PATH"
          $password = ConvertTo-SecureString -String "$env:CERT_PASSWORD" -Force -AsPlainText
          
          # å®‰è£…è¯ä¹¦åˆ°å½“å‰ç”¨æˆ·å­˜å‚¨
          $cert = Import-PfxCertificate -FilePath $certPath -CertStoreLocation Cert:\CurrentUser\My -Password $password
          Write-Host "Certificate installed: $($cert.Thumbprint)"
          
          # å¯¼å‡ºå…¬é’¥è¯ä¹¦ä¾›ç”¨æˆ·å®‰è£…
          $publicCertPath = "ppmeta\PPMeta-CodeSigning-Certificate.cer"
          Export-Certificate -Cert $cert -FilePath $publicCertPath -Type CERT
          Write-Host "Public certificate exported: $publicCertPath"
          
          # åˆ›å»ºè¯ä¹¦å®‰è£…è¯´æ˜
          $isProduction = $env:VSTO_CERTIFICATE -and $env:VSTO_CERTIFICATE -ne ""
          $certType = if ($isProduction) { "ç”Ÿäº§ç¯å¢ƒ" } else { "å¼€å‘æµ‹è¯•" }
          @"
          PPMeta ä»£ç ç­¾åè¯ä¹¦å®‰è£…è¯´æ˜
          =====================================
          
          è¯ä¹¦ç±»å‹: $certType è¯ä¹¦
          
          å¦‚æœæ‚¨åœ¨è¿è¡ŒPPMetaæ—¶é‡åˆ°"Windowsæ— æ³•éªŒè¯æ­¤è½¯ä»¶çš„å‘å¸ƒè€…"è­¦å‘Šï¼Œ
          è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å®‰è£…æˆ‘ä»¬çš„ä»£ç ç­¾åè¯ä¹¦ï¼š
          
          æ–¹æ³•1: åŒå‡»å®‰è£…ï¼ˆæ¨èï¼‰
          1. åŒå‡» PPMeta-CodeSigning-Certificate.cer æ–‡ä»¶
          2. ç‚¹å‡»"å®‰è£…è¯ä¹¦..."
          3. é€‰æ‹©"å½“å‰ç”¨æˆ·"ï¼Œç‚¹å‡»"ä¸‹ä¸€æ­¥"
          4. é€‰æ‹©"å°†æ‰€æœ‰çš„è¯ä¹¦éƒ½æ”¾å…¥ä¸‹åˆ—å­˜å‚¨"
          5. ç‚¹å‡»"æµè§ˆ..."ï¼Œé€‰æ‹©"å—ä¿¡ä»»çš„å‘å¸ƒè€…"
          6. ç‚¹å‡»"ç¡®å®š"ï¼Œç„¶å"ä¸‹ä¸€æ­¥"ï¼Œæœ€å"å®Œæˆ"
          
          æ–¹æ³•2: ä½¿ç”¨PowerShellï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
          1. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡ŒPowerShell
          2. æ‰§è¡Œå‘½ä»¤ï¼š
             Import-Certificate -FilePath "PPMeta-CodeSigning-Certificate.cer" -CertStoreLocation Cert:\LocalMachine\TrustedPublisher
          
          æ–¹æ³•3: ä½¿ç”¨ç»„ç­–ç•¥ï¼ˆä¼ä¸šç¯å¢ƒï¼‰
          è”ç³»æ‚¨çš„ITç®¡ç†å‘˜ï¼Œå°†æ­¤è¯ä¹¦æ·»åŠ åˆ°"å—ä¿¡ä»»çš„å‘å¸ƒè€…"ç»„ç­–ç•¥ä¸­ã€‚
          
          æ³¨æ„äº‹é¡¹ï¼š
          - å®‰è£…è¯ä¹¦åï¼ŒPPMetaè½¯ä»¶å°†è¢«Windowsä¿¡ä»»
          - æ­¤è¯ä¹¦ä»…ç”¨äºéªŒè¯PPMetaè½¯ä»¶çš„çœŸå®æ€§
          - å¦‚æœæ‚¨ä¸ä¿¡ä»»æ­¤è¯ä¹¦ï¼Œè¯·ä¸è¦å®‰è£…
          $(if (-not $isProduction) { "- âš ï¸ è¿™æ˜¯å¼€å‘æµ‹è¯•è¯ä¹¦ï¼Œä¸æ˜¯æ­£å¼CAé¢å‘çš„è¯ä¹¦" })
          
          è¯ä¹¦ä¿¡æ¯ï¼š
          ä¸»é¢˜: $($cert.Subject)
          æŒ‡çº¹: $($cert.Thumbprint)
          æœ‰æ•ˆæœŸ: $($cert.NotBefore.ToString('yyyy-MM-dd')) è‡³ $($cert.NotAfter.ToString('yyyy-MM-dd'))
          "@ | Out-File -FilePath "ppmeta\CERTIFICATE_INSTALL_GUIDE.txt" -Encoding UTF8
          
          # æ›´æ–°é¡¹ç›®æ–‡ä»¶ä¸­çš„è¯ä¹¦æŒ‡çº¹
          $projFile = "ppmeta\ppmeta.csproj"
          $content = Get-Content $projFile -Raw
          $content = $content -replace '<ManifestCertificateThumbprint>.*</ManifestCertificateThumbprint>', "<ManifestCertificateThumbprint>$($cert.Thumbprint)</ManifestCertificateThumbprint>"
          Set-Content $projFile $content

      - name: Build installer project with dependencies
        id: build
        shell: pwsh
        run: |
          $configuration = "${{ inputs.configuration }}"
          
          if (Test-Path "ppSetup\ppSetup.vdproj") {
            Write-Host "Building Visual Studio installer project with devenv..."
            Write-Host "Configuration: $configuration"
            
            # å…ˆæ£€æŸ¥ppmetaé¡¹ç›®çš„è¾“å‡º
            Write-Host "Checking ppmeta project output before building installer..."
            if (Test-Path "ppmeta\bin\$configuration\ppmeta.dll") {
              Write-Host "âœ… ppmeta.dll found in bin\$configuration"
            }
            if (Test-Path "ppmeta\obj\$configuration\ppmeta.dll") {
              Write-Host "âœ… ppmeta.dll found in obj\$configuration"
            } else {
              Write-Host "âŒ ppmeta.dll NOT found in obj\$configuration"
              Write-Host "Installing directly to obj directory..."
              
              # ç¡®ä¿objç›®å½•å­˜åœ¨å¹¶å¤åˆ¶å¿…è¦æ–‡ä»¶
              New-Item -ItemType Directory -Path "ppmeta\obj\$configuration" -Force | Out-Null
              
              if (Test-Path "ppmeta\bin\$configuration\ppmeta.dll") {
                Copy-Item "ppmeta\bin\$configuration\ppmeta.dll" "ppmeta\obj\$configuration\" -Force
                Write-Host "âœ… Copied ppmeta.dll to obj\$configuration"
              }
              
              if (Test-Path "ppmeta\bin\$configuration\ppmeta.dll.manifest") {
                Copy-Item "ppmeta\bin\$configuration\ppmeta.dll.manifest" "ppmeta\obj\$configuration\" -Force
                Write-Host "âœ… Copied ppmeta.dll.manifest to obj\$configuration"
              }
              
              if (Test-Path "ppmeta\bin\$configuration\ppmeta.vsto") {
                Copy-Item "ppmeta\bin\$configuration\ppmeta.vsto" "ppmeta\obj\$configuration\" -Force
                Write-Host "âœ… Copied ppmeta.vsto to obj\$configuration"
              }
            }
            
            Write-Host "Note: devenv will automatically build ppmeta project dependencies if needed"
            
            try {
              # ä½¿ç”¨/buildå‘½ä»¤æ„å»ºæ•´ä¸ªè§£å†³æ–¹æ¡ˆï¼ŒæŒ‡å®šå®‰è£…ç¨‹åºé¡¹ç›®
              Write-Host "Running: devenv ppmeta.sln /build $configuration /project ppSetup"
              devenv ppmeta.sln /build $configuration /project ppSetup
              
              $msiPath = "ppSetup\$configuration\ppSetup.msi"
              if (Test-Path $msiPath) {
                Write-Host "âœ… Successfully built installer: $msiPath"
                $msiSize = (Get-Item $msiPath).Length
                Write-Host "   File size: $([math]::Round($msiSize/1MB, 2)) MB"
                echo "installer-path=$msiPath" >> $env:GITHUB_OUTPUT
              } else {
                Write-Host "âŒ Installer was not created at expected path: $msiPath"
                Write-Host "Checking all possible output locations..."
                
                # æœç´¢æ‰€æœ‰å¯èƒ½çš„MSIæ–‡ä»¶ä½ç½®
                $msiFiles = Get-ChildItem -Recurse -Filter "*.msi" -ErrorAction SilentlyContinue
                if ($msiFiles) {
                  Write-Host "Found MSI files:"
                  $msiFiles | ForEach-Object { Write-Host "  $($_.FullName) ($(([math]::Round($_.Length/1KB, 2))) KB)" }
                } else {
                  Write-Host "No MSI files found anywhere"
                }
                
                # æ£€æŸ¥ppSetupç›®å½•å†…å®¹
                if (Test-Path "ppSetup") {
                  Write-Host "Contents of ppSetup directory:"
                  Get-ChildItem "ppSetup" -Recurse | ForEach-Object { 
                    if ($_.PSIsContainer) {
                      Write-Host "  ğŸ“ $($_.FullName)"
                    } else {
                      Write-Host "  ğŸ“„ $($_.FullName) ($(([math]::Round($_.Length/1KB, 2))) KB)"
                    }
                  }
                } else {
                  Write-Host "ppSetup directory not found"
                }
                
                throw "Installer build failed - MSI not found"
              }
            }
            catch {
              Write-Host "âŒ Failed to build installer: $($_.Exception.Message)"
              Write-Host ""
              Write-Host "ğŸ” Diagnostic Information:"
              Write-Host "Configuration: $configuration"
              Write-Host "Working Directory: $(Get-Location)"
              
              # æ£€æŸ¥ppmetaé¡¹ç›®çŠ¶æ€
              Write-Host ""
              Write-Host "ğŸ“‚ ppmeta project files:"
              if (Test-Path "ppmeta\bin\$configuration") {
                Write-Host "  bin\$configuration contents:"
                Get-ChildItem "ppmeta\bin\$configuration" | ForEach-Object { Write-Host "    $($_.Name)" }
              } else {
                Write-Host "  âŒ bin\$configuration directory not found"
              }
              
              if (Test-Path "ppmeta\obj\$configuration") {
                Write-Host "  obj\$configuration contents:"
                Get-ChildItem "ppmeta\obj\$configuration" | ForEach-Object { Write-Host "    $($_.Name)" }
              } else {
                Write-Host "  âŒ obj\$configuration directory not found"
              }
              
              # æ£€æŸ¥ppSetupé¡¹ç›®çŠ¶æ€
              Write-Host ""
              Write-Host "ğŸ“‚ ppSetup project files:"
              if (Test-Path "ppSetup") {
                Get-ChildItem "ppSetup" | ForEach-Object { Write-Host "  $($_.Name)" }
              } else {
                Write-Host "  âŒ ppSetup directory not found"
              }
              
              throw
            }
          } else {
            Write-Host "âŒ No installer project found at ppSetup\ppSetup.vdproj"
            Write-Host "Available files in current directory:"
            Get-ChildItem -Recurse -Filter "*.vdproj" | ForEach-Object { Write-Host "  $($_.FullName)" }
            throw "Installer project not found"
          }

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: installer-${{ inputs.configuration }}
          path: ${{ steps.build.outputs.installer-path }}
          retention-days: 30
